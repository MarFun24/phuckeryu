<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>University of Phuckery - Degree Customizer</title>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', Helvetica, Arial, sans-serif; }
    .style-btn.active { background: #01538B !important; color: white !important; border-color: #01538B !important; }
    
    /* Preview Container */
    .preview-container {
      aspect-ratio: 1000 / 775;
      background: #f3f4f6;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .preview-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }
    
    .preview-image.active {
      display: block;
    }
    
    .preview-placeholder {
      text-align: center;
      padding: 40px;
    }
    
    /* Mock Stripe Checkout Styles */
    .stripe-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .stripe-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .stripe-checkout {
      background: #fff;
      width: 100%;
      max-width: 450px;
      border-radius: 12px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      transform: scale(0.95) translateY(20px);
      transition: all 0.3s ease;
    }
    .stripe-modal-overlay.active .stripe-checkout {
      transform: scale(1) translateY(0);
    }
    .stripe-header {
      background: linear-gradient(135deg, #635bff 0%, #7a73ff 100%);
      padding: 24px;
      color: white;
    }
    .stripe-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.2s;
      background: #fff;
    }
    .stripe-input:focus {
      outline: none;
      border-color: #635bff;
      box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
    }
    .stripe-btn {
      width: 100%;
      padding: 14px;
      background: #635bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .stripe-btn:hover {
      background: #4f46e5;
    }
    .stripe-btn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }
    .demo-banner {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px dashed #f59e0b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .demo-banner-icon {
      background: #f59e0b;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      flex-shrink: 0;
    }
    .success-state { text-align: center; padding: 40px 24px; }
    .success-checkmark {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      animation: scaleIn 0.4s ease;
    }
    @keyframes scaleIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Date Input Styling */
    input[type="date"] {
      position: relative;
      background: white;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
    }
    
    /* Disabled/Coming Soon Styles */
    .price-option.disabled {
      opacity: 0.5;
      cursor: not-allowed !important;
      pointer-events: none;
    }
    .coming-soon-badge {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body style="background-color: #EAEAEE; min-height: 100vh;">
  
  <header style="background: linear-gradient(135deg, #01538B 0%, #023a61 100%); padding: 1.5rem 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
    <div class="max-w-[1800px] mx-auto">
      <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wide">University of Phuckery</h1>
      <p class="text-sm text-blue-100 mt-1 opacity-90">Customize Your Prestigious Degree</p>
    </div>
  </header>

  <div class="max-w-[1800px] mx-auto p-4 md:p-8">
    <div class="flex flex-col lg:flex-row gap-6 items-start">
      
      <!-- LEFT PANEL: Form Controls -->
      <div class="w-full lg:w-[420px] flex-shrink-0 bg-white rounded-xl shadow-xl p-5 md:p-6 lg:sticky lg:top-4 border border-gray-100">
        <h2 class="text-lg md:text-xl font-bold mb-4" style="color: #3A3C3E;">Degree Details</h2>
        
        <div class="space-y-3" id="diplomaForm">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">First Name</label>
              <input type="text" id="firstName" value="Recipient Name" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all">
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Last Name</label>
              <input type="text" id="lastName" value="Here" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all">
            </div>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Date of Certification</label>
            <input type="date" id="certificationDate" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all">
            <div class="text-xs text-gray-500 mt-1" id="datePreview"></div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Degree Level</label>
              <select id="degreeLevel" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all bg-white">
                <option value="Bachelor">Bachelor</option>
                <option value="Master" selected>Master</option>
                <option value="PhD">PhD</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Faculty</label>
              <select id="faculty" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all bg-white">
                <option value="Early Childhood Chaos & Strategic Resistance">Early Childhood Chaos & Strategic Resistance</option>
                <option value="Digital Communication & Emotional Regulation">Digital Communication & Emotional Regulation</option>
                <option value="Workplace Dynamics & Institutional Navigation">Workplace Dynamics & Institutional Navigation</option>
                <option value="Professional Composure & Conflict Management">Professional Composure & Conflict Management</option>
                <option value="Personal Boundaries & Resource Protection">Personal Boundaries & Resource Protection</option>
                <option value="Domestic Strategy & Tactical Positioning">Domestic Strategy & Tactical Positioning</option>
                <option value="Household Systems & Operational Avoidance">Household Systems & Operational Avoidance</option>
                <option value="Environmental Negotiation & Power Distribution">Environmental Negotiation & Power Distribution</option>
                <option value="Social Etiquette & Interpersonal Diplomacy">Social Etiquette & Interpersonal Diplomacy</option>
                <option value="Family Relations & Generational Navigation">Family Relations & Generational Navigation</option>
                <option value="Logical Systems & Human Translation">Logical Systems & Human Translation</option>
                <option value="Companion Animal Stewardship & Devotional Economics">Companion Animal Stewardship & Devotional Economics</option>
                <option value="Neighbourly Relations & Acoustic Diplomacy">Neighbourly Relations & Acoustic Diplomacy</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Achievement Description</label>
            <select id="achievementSelect" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all bg-white mb-2">
              <option value="feral energy, volume control defiance, bodily function audacity, and strategic bedtime resistance.">üßí Feral energy, volume control defiance, bodily function audacity, and strategic bedtime resistance.</option>
              <option value="mastering email tone while feeling none.">üìß Mastering email tone while feeling none.</option>
              <option value="attending meetings that should have been emails.">üìã Attending meetings that should have been emails.</option>
              <option value="professional restraint during repeated incompetence.">üò§ Professional restraint during repeated incompetence.</option>
              <option value="unapologetic cake consumption without sharing.">üç∞ Unapologetic cake consumption without sharing.</option>
              <option value="in weaponizing blankets throughout the night.">üõèÔ∏è Weaponizing blankets throughout the night.</option>
              <option value="in strategic towel abandonment despite repeated reminders.">üß∫ Strategic towel abandonment despite repeated reminders.</option>
              <option value="in thermostat negotiations ending in silent compromise.">üå°Ô∏è Thermostat negotiations ending in silent compromise.</option>
              <option value="in smiling politely through unsolicited life advice.">üòä Smiling politely through unsolicited life advice.</option>
              <option value="in surviving holidays without correcting anyone.">üéÑ Surviving holidays without correcting anyone.</option>
              <option value="in translating human requests into logical constraints.">ü§ñ Translating human requests into logical constraints.</option>
              <option value="in unconditional devotion to non-paying furry dependents.">üêæ Unconditional devotion to non-paying furry dependents.</option>
              <option value="in surviving passive-aggressive noise complaints with dignified restraint.">üè† Surviving passive-aggressive noise complaints with dignified restraint.</option>
              <option value="custom">‚úèÔ∏è Write your own...</option>
            </select>
            <textarea id="achievementCustom" rows="2" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all resize-none hidden" placeholder="Write your custom achievement..."></textarea>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Recipient Email Address <span class="text-red-400">*</span></label>
            <input type="email" id="recipientEmail" placeholder="recipient@example.com" class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all">
            <p class="text-xs text-gray-500 mt-1.5 leading-relaxed">Send the certificate to someone else anonymously ‚Äî let the phuckery fly.</p>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color: #3A3C3E;">Sender's Email Address <span class="text-red-400">*</span></label>
            <input type="email" id="buyerEmail" placeholder="you@example.com" required class="form-input w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all">
            <p class="text-xs text-gray-500 mt-1.5 leading-relaxed">We'll send your order confirmation and certificate here.</p>
          </div>

          <div class="pt-3 border-t border-gray-200">
            <label class="block text-xs font-semibold mb-2" style="color: #3A3C3E;">Choose Your Package</label>
            <div class="space-y-2" id="priceTiers">
              <label class="price-option flex items-center p-3 rounded-lg border-2 border-gray-200 cursor-pointer hover:border-blue-300 transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                <input type="radio" name="priceTier" value="digital" data-price="9.99" data-label="Digital Download" class="mr-3 accent-blue-600" checked>
                <div class="flex-1">
                  <div class="font-semibold text-sm" style="color: #3A3C3E;">Digital Download</div>
                  <div class="text-xs text-gray-500">High-res PDF delivered via email</div>
                </div>
                <div class="font-bold text-blue-600">$9.99</div>
              </label>
              <label class="price-option disabled flex items-center p-3 rounded-lg border-2 border-gray-200 cursor-not-allowed">
                <input type="radio" name="priceTier" value="printed" data-price="39.99" data-label="Printed Diploma" class="mr-3 accent-blue-600" disabled>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="font-semibold text-sm" style="color: #3A3C3E;">Printed Diploma</div>
                    <span class="coming-soon-badge">Coming Soon</span>
                  </div>
                  <div class="text-xs text-gray-500">Premium cardstock, shipped to you</div>
                </div>
              </label>
              <label class="price-option disabled flex items-center p-3 rounded-lg border-2 border-gray-200 cursor-not-allowed">
                <input type="radio" name="priceTier" value="framed" data-price="79.99" data-label="Printed & Framed" class="mr-3 accent-blue-600" disabled>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="font-semibold text-sm" style="color: #3A3C3E;">Printed & Framed</div>
                    <span class="coming-soon-badge">Coming Soon</span>
                  </div>
                  <div class="text-xs text-gray-500">Ready to hang, museum-quality frame</div>
                </div>
              </label>
            </div>
          </div>

          <div class="pt-3 border-t border-gray-200">
            <label class="block text-xs font-semibold mb-2" style="color: #3A3C3E;">What's Your Vibe?</label>
            <div class="grid grid-cols-3 gap-2" id="styleButtons">
              <button type="button" data-style="classic" class="style-btn active p-2.5 rounded-lg border-2 text-xs font-medium transition-all">
                <div class="text-lg mb-1">üéì</div>
                <div class="text-[10px] leading-tight">Classic Academia</div>
              </button>
              <button type="button" data-style="boujie" class="style-btn p-2.5 rounded-lg border-2 border-gray-200 bg-white text-gray-600 hover:border-gray-400 transition-all">
                <div class="text-lg mb-1">‚ú®</div>
                <div class="text-[10px] leading-tight">Boujie & Luxe</div>
              </button>
              <button type="button" data-style="legal" class="style-btn p-2.5 rounded-lg border-2 border-gray-200 bg-white text-gray-600 hover:border-gray-400 transition-all">
                <div class="text-lg mb-1">‚öñÔ∏è</div>
                <div class="text-[10px] leading-tight">Law School</div>
              </button>
              <button type="button" data-style="medical" class="style-btn p-2.5 rounded-lg border-2 border-gray-200 bg-white text-gray-600 hover:border-gray-400 transition-all">
                <div class="text-lg mb-1">üè•</div>
                <div class="text-[10px] leading-tight">Medical</div>
              </button>
              <button type="button" data-style="creative" class="style-btn p-2.5 rounded-lg border-2 border-gray-200 bg-white text-gray-600 hover:border-gray-400 transition-all">
                <div class="text-lg mb-1">üé®</div>
                <div class="text-[10px] leading-tight">Creatives</div>
              </button>
              <button type="button" data-style="tech" class="style-btn p-2.5 rounded-lg border-2 border-gray-200 bg-white text-gray-600 hover:border-gray-400 transition-all">
                <div class="text-lg mb-1">ü§ñ</div>
                <div class="text-[10px] leading-tight">AI / Tech</div>
              </button>
              <button type="button" data-style="kids" class="style-btn p-2.5 rounded-lg border-2 border-gray-200 bg-white text-gray-600 hover:border-gray-400 transition-all col-span-3">
                <div class="text-lg mb-1">ü¶•</div>
                <div class="text-[10px] leading-tight">Lil Phuckers (Digital Only)</div>
              </button>
            </div>
          </div>
          
          <!-- PURCHASE BUTTON -->
          <button id="checkoutBtn" class="w-full font-bold py-3 px-4 text-sm rounded-lg transition-all duration-200 text-white hover:opacity-90 shadow-lg mt-3" style="background: linear-gradient(135deg, #01538B 0%, #023a61 100%);">
            Purchase for $9.99
          </button>
          <p class="text-gray-500 text-xs mt-2 text-center">Click a style to preview your diploma</p>
        </div>
      </div>

      <!-- RIGHT PANEL: Template Preview -->
      <div class="w-full flex-grow bg-white rounded-xl shadow-xl p-5 md:p-6 border border-gray-100">
        <h2 class="text-xl md:text-2xl font-bold mb-6" style="color: #3A3C3E;">Template Preview</h2>
        
        <div class="preview-container" id="previewContainer">
          <!-- Placeholder -->
          <div class="preview-placeholder" id="previewEmpty">
            <div class="text-6xl mb-4">üéì</div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Your diploma preview will appear here</h3>
            <p class="text-sm text-gray-500">Click a style button to see the template</p>
          </div>
          
          <!-- Live PDF Preview (rendered as image) -->
          <canvas id="previewCanvas" class="preview-image active" style="width:100%;height:100%;"></canvas>

          <!-- Fallback static images (shown while loading) -->
          <img id="template-classic" src="./CLASSIC_ACADEMIA_BG.png" class="preview-image" alt="Classic Academia Template">
          <img id="template-boujie" src="./BOUGIE___LUXE_BG.png" class="preview-image" alt="Boujie & Luxe Template">
          <img id="template-legal" src="./LAW_SCHOOL_BG.png" class="preview-image" alt="Law School Template">
          <img id="template-medical" src="./MEDICAL_BG.png" class="preview-image" alt="Medical Template">
          <img id="template-creative" src="./CREATIVES_BG.png" class="preview-image" alt="Creatives Template">
          <img id="template-tech" src="./AI_TECH_BG.png" class="preview-image" alt="AI/Tech Template">
          <img id="template-kids" src="./LIL_PHUCKERS_BG.png" class="preview-image" alt="Lil Phuckers Template">
        </div>
        
        <p class="text-xs text-center mt-4" style="color:#3A3C3E;opacity:0.6;">
          Template preview. Final diploma will be customized with your information.
        </p>
      </div>
    </div>
  </div>

  <!-- Stripe Payment Modal -->
  <div class="stripe-modal-overlay" id="stripeModal">
    <div class="stripe-checkout">
      <div class="stripe-header">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-content-center overflow-hidden">
              <img src="https://res.cloudinary.com/ded9cb1wd/image/upload/v1767813427/PU_Logo_Blue_White_rwkqvn.png" alt="Logo" class="w-8 h-8 object-contain m-auto">
            </div>
            <div>
              <div class="font-semibold">University of Phuckery</div>
              <div class="text-sm opacity-80" id="modalProductName">Digital Download</div>
            </div>
          </div>
          <button onclick="closeStripeModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <div class="text-3xl font-bold" id="modalPrice">$9.99</div>
      </div>
      
      <div class="p-6">
        <form id="payment-form">
          <div id="payment-element" class="mb-4">
            <!-- Stripe Payment Element will be inserted here -->
          </div>
          
          <div id="payment-message" class="hidden text-sm text-red-600 mb-4"></div>
          
          <button type="submit" class="stripe-btn" id="submit">
            <span id="button-text">Pay now</span>
            <div id="spinner" class="hidden inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></div>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ===========================================
    // STATE
    // ===========================================
    let currentStyle = 'classic';

    // ===========================================
    // DOM ELEMENTS
    // ===========================================
    const checkoutBtn = document.getElementById('checkoutBtn');
    const previewEmpty = document.getElementById('previewEmpty');
    const achievementSelect = document.getElementById('achievementSelect');
    const achievementCustom = document.getElementById('achievementCustom');
    const certificationDate = document.getElementById('certificationDate');
    const datePreview = document.getElementById('datePreview');

    // ===========================================
    // DATE FORMATTING
    // ===========================================
    function formatDate(dateString) {
      if (!dateString) return '';

      // Parse parts directly to avoid UTC timezone shift
      const [year, month, day] = dateString.split('-').map(Number);
      const monthNames = ['January','February','March','April','May','June',
                          'July','August','September','October','November','December'];
      
      // Add ordinal suffix (st, nd, rd, th)
      const suffix = (day) => {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      };
      
      return `${day}${suffix(day)} day of ${monthNames[month - 1]}, ${year}`;
    }

    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    certificationDate.value = today;
    datePreview.textContent = `Will appear as: ${formatDate(today)}`;

    certificationDate.addEventListener('change', function() {
      if (this.value) {
        datePreview.textContent = `Will appear as: ${formatDate(this.value)}`;
      } else {
        datePreview.textContent = '';
      }
    });

    // ===========================================
    // STYLE SWITCHING
    // ===========================================
    function switchTemplate(style) {
      // Hide all templates
      document.querySelectorAll('.preview-image').forEach(img => {
        img.classList.remove('active');
      });
      
      // Hide placeholder
      previewEmpty.style.display = 'none';
      
      // Show selected template
      const templateImg = document.getElementById(`template-${style}`);
      if (templateImg) {
        templateImg.classList.add('active');
      }
      
      currentStyle = style;
    }

    // ===========================================
    // EVENT LISTENERS
    // ===========================================
    
    // Achievement dropdown
    achievementSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        achievementCustom.classList.remove('hidden');
        achievementCustom.focus();
      } else {
        achievementCustom.classList.add('hidden');
      }
    });
    
    // Style buttons
    document.querySelectorAll('.style-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Update button states
        document.querySelectorAll('.style-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = 'white';
          b.style.color = '#6b7280';
          b.style.borderColor = '#e5e7eb';
        });
        this.classList.add('active');
        
        // Switch template
        const style = this.dataset.style;
        switchTemplate(style);
        schedulePreview();
      });
    });
    
    // Price tier updates (only fires for enabled options)
    document.querySelectorAll('input[name="priceTier"]:not([disabled])').forEach(input => {
      input.addEventListener('change', () => {
        const price = input.dataset.price;
        checkoutBtn.textContent = `Purchase for $${price}`;
      });
    });
    
    // Checkout
    checkoutBtn.addEventListener('click', openStripeModal);
    
    // ===========================================
    // STRIPE PAYMENT ELEMENT
    // ===========================================
    const stripeModal = document.getElementById('stripeModal');
    const stripe = Stripe('pk_live_51Sv5nAPVCYNIQbDA9Y4fMrDahZq43rxfz15DSpkSzt6Wb3GKI8Cye47l3dbDuCcgBInW180B5VUkJrKrRH9Tjpo200yblmvnL2');
    let elements;
    let clientSecret;
    let paymentInProgress = false;
    
    async function openStripeModal() {
      // Gather form data
      const buyerEmail = document.getElementById('buyerEmail').value.trim();
      const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        certificationDate: datePreview.textContent.replace('Will appear as: ', ''),
        degreeLevel: document.getElementById('degreeLevel').value,
        faculty: document.getElementById('faculty').value,
        achievement: achievementSelect.value === 'custom' ? achievementCustom.value : achievementSelect.value,
        buyerEmail: buyerEmail,
        recipientEmail: document.getElementById('recipientEmail').value,
        style: currentStyle,
        priceId: document.querySelector('input[name="priceTier"]:checked').dataset.price === '9.99' ? 'price_1SyyrbPVCYNIQbDAltXaZL6q' : ''
      };

      // Validate
      if (!formData.firstName || !formData.lastName || !formData.certificationDate) {
        alert('Please fill in all required fields');
        return;
      }

      if (!buyerEmail) {
        alert('Please enter your email address so we can send your confirmation and certificate.');
        document.getElementById('buyerEmail').focus();
        return;
      }
      
      // Update modal header
      const selected = document.querySelector('input[name="priceTier"]:checked');
      document.getElementById('modalProductName').textContent = selected.dataset.label;
      document.getElementById('modalPrice').textContent = '$0.80 CAD'; // testing price
      
      // Show modal
      stripeModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      try {
        // Create Payment Intent
        const response = await fetch('/api/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to create payment intent');
        }
        
        clientSecret = data.clientSecret;
        
        // Initialize Stripe Elements
        const appearance = {
          theme: 'stripe',
          variables: {
            colorPrimary: '#635bff',
          }
        };
        
        elements = stripe.elements({ appearance, clientSecret });
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
      } catch (error) {
        console.error('Payment initialization error:', error);
        showMessage(error.message);
      }
    }
    
    function closeStripeModal() {
      stripeModal.classList.remove('active');
      document.body.style.overflow = '';

      // Cleanup
      if (elements) {
        elements.getElement('payment')?.unmount();
        elements = null;
      }

      // Reset payment state so user can try again from scratch
      paymentInProgress = false;
      clientSecret = null;
    }
    
    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', handleSubmit);
    
    async function handleSubmit(e) {
      e.preventDefault();

      // Prevent duplicate submissions
      if (paymentInProgress) return;
      paymentInProgress = true;
      setLoading(true);

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + '/success.html',
        },
      });

      if (error) {
        // Only reset for errors that allow retry (not network/server errors after charge)
        if (error.type === 'card_error' || error.type === 'validation_error') {
          paymentInProgress = false;
        }
        showMessage(error.message);
        setLoading(false);
      }
      // Customer will be redirected to success page automatically
    }
    
    function showMessage(messageText) {
      const messageContainer = document.querySelector('#payment-message');
      messageContainer.classList.remove('hidden');
      messageContainer.textContent = messageText;
      
      setTimeout(() => {
        messageContainer.classList.add('hidden');
        messageContainer.textContent = '';
      }, 4000);
    }
    
    function setLoading(isLoading) {
      const submitButton = document.querySelector('#submit');
      const spinner = document.querySelector('#spinner');
      const buttonText = document.querySelector('#button-text');
      
      if (isLoading) {
        submitButton.disabled = true;
        spinner.classList.remove('hidden');
        buttonText.textContent = 'Processing...';
      } else {
        submitButton.disabled = false;
        spinner.classList.add('hidden');
        buttonText.textContent = 'Pay now';
      }
    }
    
    // Close modal on overlay click
    stripeModal.addEventListener('click', (e) => {
      if (e.target === stripeModal) closeStripeModal();
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && stripeModal.classList.contains('active')) {
        closeStripeModal();
      }
    });
    
    // ===========================================
    // LIVE PDF PREVIEW
    // ===========================================
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let previewTimeout = null;
    const previewCanvas = document.getElementById('previewCanvas');

    function getFormData() {
      return {
        firstName: document.getElementById('firstName').value || 'Your Name',
        lastName: document.getElementById('lastName').value || 'Here',
        certificationDate: datePreview.textContent.replace('Will appear as: ', ''),
        degreeLevel: document.getElementById('degreeLevel').value,
        faculty: document.getElementById('faculty').value,
        achievement: achievementSelect.value === 'custom' ? achievementCustom.value : achievementSelect.value,
        style: currentStyle,
      };
    }

    async function updatePreview() {
      const formData = getFormData();

      try {
        const response = await fetch('/api/generate-certificate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        if (!response.ok) throw new Error('Preview generation failed');

        const pdfBytes = await response.arrayBuffer();

        // Render PDF to canvas using pdf.js
        const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        const page = await pdf.getPage(1);

        const container = document.getElementById('previewContainer');
        const containerWidth = container.clientWidth;
        const viewport = page.getViewport({ scale: 1 });
        const scale = containerWidth / viewport.width;
        const scaledViewport = page.getViewport({ scale });

        previewCanvas.width = scaledViewport.width;
        previewCanvas.height = scaledViewport.height;

        const ctx = previewCanvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;

        // Show canvas, hide static images
        document.querySelectorAll('.preview-image').forEach(img => img.classList.remove('active'));
        previewCanvas.classList.add('active');
        previewEmpty.style.display = 'none';

      } catch (err) {
        console.error('Preview error:', err);
        // Fall back to static background image
        document.querySelectorAll('.preview-image').forEach(img => img.classList.remove('active'));
        const fallback = document.getElementById(`template-${currentStyle}`);
        if (fallback) fallback.classList.add('active');
        previewEmpty.style.display = 'none';
      }
    }

    function schedulePreview() {
      clearTimeout(previewTimeout);
      previewTimeout = setTimeout(updatePreview, 400);
    }

    // Attach live preview to all form inputs
    document.querySelectorAll('#diplomaForm input, #diplomaForm select, #diplomaForm textarea').forEach(el => {
      el.addEventListener('input', schedulePreview);
      el.addEventListener('change', schedulePreview);
    });

    // ===========================================
    // INITIALIZATION
    // ===========================================
    // Show classic template by default and trigger first preview
    switchTemplate('classic');
    schedulePreview();
  </script>
</body>
</html>
